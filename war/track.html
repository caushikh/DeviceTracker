<!DOCTYPE html>
<html>
<head>
	<title>sample maps app</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta charset="utf-8">
	<!--<link rel="styleshet" href="postlogin.css"/>-->
	<!--<link rel="stylesheet" href="prelogin.css"/>-->
	<link rel="stylesheet" href="styles.css"/>
	<link rel="stylesheet" href="jquery.mobile-1.2.0.min.css" />
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFSBkXjV3dteXXbZKZbhVzshHNd54ISUY&sensor=true"></script>
	<script src="jquery-1.8.2.min.js"></script>
	<script src="jquery.validate.js"></script>
	<script src="jquery.mobile-1.2.0.min.js"></script>
	<script src="prelogin.js"></script>
	<script>
		var stops = [];
		$(document).ready(function() {
			var map;
			var poly;
			var loctimer;
			function initialize(lat,lng) {
				// create map with following map parameters
				var pos = new google.maps.LatLng(lat,lng);
				stops.push(pos);
				var mapOptions = {
					zoom: 15,
					center: pos
				};
				
				map = new google.maps.Map(document.getElementById('mapcanvas'), mapOptions);
				
				var marker = new google.maps.Marker({
					position: pos,
					map: map
				});
  
				poly = new google.maps.Polyline({
					path: stops,
					strokeColor: '#FF0000',
					strokeWeight: 1,
					map: map
				});
				
			}
			function success(position) {
				var lat = position.coords.latitude;
				var lng = position.coords.longitude;
				$("#date").text(Date());
				google.maps.event.addDomListener(window,'load',initialize(lat,lng));
			}
			function error(error) {
				$("#mapcanvas").append("error code: "+error.code+"<br>error message: "+error.message);
			}
			function updatePosition(position) {
				var lat = position.coords.latitude;
				var lng = position.coords.longitude;
				$("#date").text(Date());
				var newPos = new google.maps.LatLng(lat,lng);
				stops.push(newPos);
				var marker = new google.maps.Marker({
					position: newPos,
					map: map
				});
				map.setCenter(newPos);
				poly.setPath(stops);
			}
			function getLocation(success,error) {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(success,error);
				}
				else {
					$("#mapcanvas").append("Geolocation is not supported by your browser.");
				}
			}
			
			getLocation(success,error);
			loctimer = setInterval(function() { getLocation(updatePosition,error) }, 60000);
		});
		function save() {
				if ($("#save").val() == "") {
					$("#save").append("Please enter the name of this route:<br><input type=\"text\" id=\"name\">");
					$("#save").append("<button onclick=\"upload()\">Submit</button>");
				}
		}
		function upload() {
				if ($("#name").val() == "") {
					$("#save").empty();
					$("#save").append("Route name not entered. Please enter the name of this route:<br><input type=\"text\" id=\"name\">");
					$("#save").append("<button onclick=\"upload()\">Submit</button>");
				}
				else {
					var stopsjson = [];
					$("#save").hide();
					var routename = $("#name").val();
					stopsjson = stopsJson(stops);
					var test = ["test","test2"]
					$.ajax({
						method: "POST",
						contentType: "application/json",
						url: "savemap.jsp",
						data: {
							"locations": stopsjson,
							"name": routename
						},
						success: function(data) {
							console.log(data)
							$("#msg").empty();
							$("#msg").append("Map saved successfully. <a href=\"homesplash.jsp\">Click Here </a>to go back.");
						},
						error: function(a,b,c) {
							$("#msg").empty();
							$("#msg").append("Map could not be saved. Try again or <a href=\"homesplash.jsp\">click Here </a>to go back.");
						}
					});
				}
			}
			function stopsJson(stops) {
				var i;
				var stopsjson = []
				var tmplat;
				var tmplng;
				var loc = {};
				for (i = 0; i < stops.length; i++) {
					tmplat = stops[i].lat();
					tmplng = stops[i].lng();
					loc = {
						"lat": tmplat,
						"lng": tmplng
					};
					stopsjson.push(loc);
				}
				return stopsjson;
			}
	</script>
</head>
<body>
	<div id="body">
	<div data-role="page" id="track">
		<div data-role="header">
			<div id="title"><h2>Device is being tracked...</h2></div>
		</div>
		
		<div id="mapcanvas"></div>
		<br><br>
		<div id="update">
			<b>Last update:</b><br>
			<div id="date"></div><br>
			<button class="ui-btn" style="color:#FFFFFF; background:#FF0000" onclick="clearInterval(loctimer)">Stop Tracking</button>
			<button class="ui-btn" style="color:#FFFFFF; background:#FF0000" onclick="save()">Save Route</button>
			<div id="save"></div>
			<div id="msg"></div>
			<div data-role="footer">
				<a href="login.jsp">Logout</a>
			</div>
		</div>
	</div>
	</div>
</body>
</html>